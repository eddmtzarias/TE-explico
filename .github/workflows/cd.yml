name: CD - Continuous Deployment

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # Build and Push Docker Images
  # ============================================
  
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [backend, ai-inference, frontend-web]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
  # ============================================
  # Deploy to Staging
  # ============================================
  
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.te-explico.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --name te-explico-staging --region us-east-1
          
      - name: Deploy to Kubernetes
        working-directory: ./infra/kubernetes
        run: |
          kubectl apply -f staging/
          kubectl rollout status deployment/backend -n te-explico-staging
          kubectl rollout status deployment/ai-inference -n te-explico-staging
          kubectl rollout status deployment/frontend -n te-explico-staging
          
      - name: Run smoke tests
        run: |
          ./scripts/smoke-tests.sh staging
          
  # ============================================
  # E2E Tests on Staging
  # ============================================
  
  e2e-tests-staging:
    name: E2E Tests (Staging)
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install Playwright
        working-directory: ./tests/e2e
        run: |
          npm ci
          npx playwright install --with-deps
          
      - name: Run E2E tests
        working-directory: ./tests/e2e
        run: npm run test
        env:
          BASE_URL: https://staging.te-explico.com
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: tests/e2e/test-results/
          
  # ============================================
  # Deploy to Production
  # ============================================
  
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, e2e-tests-staging]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://te-explico.com
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        
      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --name te-explico-prod --region us-east-1
          
      - name: Blue-Green Deployment
        working-directory: ./infra/kubernetes
        run: |
          # Deploy to green environment
          kubectl apply -f production/green/
          
          # Wait for rollout
          kubectl rollout status deployment/backend-green -n te-explico-prod
          kubectl rollout status deployment/ai-inference-green -n te-explico-prod
          kubectl rollout status deployment/frontend-green -n te-explico-prod
          
      - name: Run smoke tests on green
        run: |
          ./scripts/smoke-tests.sh production-green
          
      - name: Switch traffic to green
        working-directory: ./infra/kubernetes
        run: |
          # Update service to point to green
          kubectl patch service backend -n te-explico-prod -p '{"spec":{"selector":{"version":"green"}}}'
          kubectl patch service ai-inference -n te-explico-prod -p '{"spec":{"selector":{"version":"green"}}}'
          kubectl patch service frontend -n te-explico-prod -p '{"spec":{"selector":{"version":"green"}}}'
          
      - name: Monitor deployment
        run: |
          sleep 300  # Wait 5 minutes
          ./scripts/health-check.sh production
          
      - name: Cleanup old blue deployment
        if: success()
        working-directory: ./infra/kubernetes
        run: |
          kubectl delete deployment backend-blue -n te-explico-prod
          kubectl delete deployment ai-inference-blue -n te-explico-prod
          kubectl delete deployment frontend-blue -n te-explico-prod
          
  # ============================================
  # Post-Deployment
  # ============================================
  
  notify-deployment:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    steps:
      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          text: 'Production deployment completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          
      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main' && success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release-${{ github.sha }}
          release_name: Release ${{ github.sha }}
          body: |
            Automated release from main branch
            Commit: ${{ github.sha }}
          draft: false
          prerelease: false
